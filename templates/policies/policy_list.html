{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Policy Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-10">

<!-- HEADER -->
<div class="flex flex-col md:flex-row justify-between gap-4 items-start md:items-center">
  <div>
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ dashboard_title }}</h1>
    <p class="text-gray-500 dark:text-gray-300 mt-1">Insights, analytics, and renewal alerts for all policies</p>
  </div>
  <div class="flex gap-3 flex-wrap">
    <a href="{% url 'hospitals:assign_policyholder' %}" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white shadow flex items-center gap-2">üìù Assign</a>
    <a href="{% url 'policies:add_policy' %}" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow flex items-center gap-2">‚ûï Add Policy</a>
    <button id="export-btn" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-black text-white shadow flex items-center gap-2">üì§ Export CSV</button>
  </div>
</div>

<!-- KPI CARDS -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
  <div class="bg-gradient-to-tr from-purple-600 to-purple-500 rounded-2xl shadow-lg p-5 hover:scale-105 transform transition">
    <div class="flex items-center justify-between">
      <span class="text-xs uppercase opacity-80 text-white">New This Month</span>
      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18h.01M12 6h.01M12 12h.01" />
      </svg>
    </div>
    <h2 class="mt-3 text-3xl font-extrabold text-white">{{ monthly_count }}</h2>
  </div>

  <div class="bg-gradient-to-tr from-emerald-600 to-emerald-500 rounded-2xl shadow-lg p-5 hover:scale-105 transform transition">
    <span class="text-xs uppercase opacity-80 text-white">Total Policies</span>
    <h2 class="mt-3 text-3xl font-extrabold text-white">{{ total_count }}</h2>
  </div>

  <div class="bg-gradient-to-tr from-yellow-500 to-yellow-400 rounded-2xl shadow-lg p-5 hover:scale-105 transform transition">
    <span class="text-xs uppercase opacity-80 text-white">Active Plans</span>
    <h2 class="mt-3 text-3xl font-extrabold text-white">{{ active_count }}</h2>
  </div>

  <div class="bg-gradient-to-tr from-blue-600 to-blue-500 rounded-2xl shadow-lg p-5 hover:scale-105 transform transition">
    <span class="text-xs uppercase opacity-80 text-white">Total Revenue</span>
    <h2 class="mt-3 text-3xl font-extrabold text-white">${{ total_revenue }}</h2>
  </div>

  <div class="bg-gradient-to-tr from-orange-600 to-red-500 rounded-2xl shadow-lg p-5 hover:scale-105 transform transition">
    <span class="text-xs uppercase opacity-80 text-white">Monthly Revenue</span>
    <h2 class="mt-3 text-3xl font-extrabold text-white">${{ monthly_revenue }}</h2>
  </div>
</div>

<!-- ANALYTICS + RENEWALS -->
<div class="grid lg:grid-cols-3 gap-6 mt-6">

  <!-- Chart -->
  <div class="lg:col-span-2 bg-white dark:bg-zinc-900 rounded-2xl shadow-md p-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Monthly Policy & Revenue Trends</h3>
    <canvas id="analyticsChart" class="w-full h-64"></canvas>
  </div>

  <!-- Renewal Alerts -->
  <div class="bg-white dark:bg-zinc-900 rounded-2xl shadow-md p-6 space-y-4">
    <h3 class="text-lg font-bold text-gray-800 dark:text-white">Renewal Alerts</h3>

    <div class="flex justify-between bg-yellow-100 dark:bg-yellow-900/20 p-2 rounded-lg">
      <span>Expiring Soon</span>
      <span class="font-semibold">{{ renewals.count }}</span>
    </div>

    <div class="flex justify-between bg-red-100 dark:bg-red-900/20 p-2 rounded-lg">
      <span>Expired</span>
      <span class="font-semibold">{{ expired_alerts.count }}</span>
    </div>

    <ul class="space-y-2 text-sm max-h-56 overflow-auto mt-2">
      {% for p in renewals %}
      <li class="flex justify-between border-b pb-1 hover:bg-gray-50 dark:hover:bg-zinc-800 rounded px-2 py-1 transition">
        <span>{{ p.client }}</span>
        <span class="text-yellow-600">{{ p.expiry_date }}</span>
      </li>
      {% empty %}
      <li class="text-center text-gray-400">No upcoming renewals</li>
      {% endfor %}
    </ul>
  </div>

</div>

<!-- FILTER PANEL -->
<form method="get" class="grid md:grid-cols-6 gap-3 p-5 bg-white dark:bg-zinc-900 rounded-2xl shadow mt-6">
  <input name="search" value="{{ search }}" placeholder="Search policy or client" class="rounded-lg border px-3 py-2 dark:bg-zinc-800 focus:ring focus:ring-blue-300">
  <select name="type" class="rounded-lg border px-3 py-2 dark:bg-zinc-800">
    <option value="">Policy Type</option>
    {% for t,v in policies.model.POLICY_TYPE %}
    <option value="{{ t }}" {% if t == policy_type %}selected{% endif %}>{{ v }}</option>
    {% endfor %}
  </select>
  <select name="active" class="rounded-lg border px-3 py-2 dark:bg-zinc-800">
    <option value="">Status</option>
    <option value="true" {% if active == "true" %}selected{% endif %}>Active</option>
    <option value="false" {% if active == "false" %}selected{% endif %}>Inactive</option>
  </select>
  <input type="date" name="start" value="{{ start }}" class="rounded-lg border px-3 py-2 dark:bg-zinc-800">
  <input type="date" name="end" value="{{ end }}" class="rounded-lg border px-3 py-2 dark:bg-zinc-800">
  <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow py-2">üîé Apply</button>
</form>

<!-- POLICY TABLE -->
<div class="bg-white dark:bg-zinc-900 shadow-lg rounded-2xl overflow-hidden mt-6">
  <table id="policies-table" class="w-full text-sm">
    <thead class="bg-gray-100 dark:bg-zinc-800 text-gray-600 uppercase">
      <tr>
        <th class="p-3">Policy</th>
        <th class="p-3">Client</th>
        <th class="p-3">Premium</th>
        <th class="p-3">Start</th>
        <th class="p-3">Expiry</th>
        <th class="p-3">Status</th>
        <th class="p-3">Days</th>
        <th class="p-3">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y">
      {% for p in policies %}
      <tr class="hover:bg-blue-50 dark:hover:bg-zinc-800 transition">
        <td class="p-3">{{ p.policy_number }}</td>
        <td class="p-3">{{ p.client }}</td>
        <td class="p-3 text-green-600 font-bold">${{ p.premium }}</td>
        <td class="p-3">{{ p.start_date }}</td>
        <td class="p-3">{{ p.expiry_date }}</td>
        <td class="p-3">
          {% if p.is_active %}
          <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">ACTIVE</span>
          {% else %}
          <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-semibold">INACTIVE</span>
          {% endif %}
        </td>
        <td class="p-3">{% if p.days_left >= 0 %}{{ p.days_left }} d{% else %}<span class="text-red-600">Expired</span>{% endif %}</td>
        <td class="p-3 space-x-2">
          <a href="{% url 'policies:policy_detail' p.id %}" class="text-blue-600 hover:underline">View</a>
          <a href="{% url 'policies:edit_policy' p.id %}" class="text-yellow-600 hover:underline">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="p-6 text-center text-gray-400">No policies found</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- PAGINATION -->
<div class="flex justify-center mt-6 gap-3">
  {% if page_obj.has_previous %}
  <a href="?page={{ page_obj.previous_page_number }}" class="px-4 py-2 rounded border bg-white dark:bg-zinc-900 hover:bg-gray-100">‚¨Ö Prev</a>
  {% endif %}
  <span class="px-4 py-2 bg-blue-600 text-white rounded font-bold">{{ page_obj.number }}</span>
  {% if page_obj.has_next %}
  <a href="?page={{ page_obj.next_page_number }}" class="px-4 py-2 rounded border bg-white dark:bg-zinc-900 hover:bg-gray-100">Next ‚û°</a>
  {% endif %}
</div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById("analyticsChart"), {
  type:"bar",
  data:{
    labels: {{ chart_labels|safe }},
    datasets:[
      { label:"Policies", data: {{ chart_counts|safe }}, backgroundColor:"#6366F1" },
      { label:"Revenue", data: {{ chart_revenue|safe }}, type:"line", yAxisID:"y1", borderColor:"#F59E0B", tension:0.3 }
    ]
  },
  options:{
    responsive:true,
    interaction:{mode:"index", intersect:false},
    stacked:false,
    plugins:{legend:{position:"top"}},
    scales:{
      y:{ beginAtZero:true, title:{display:true, text:"Policies"} },
      y1:{ beginAtZero:true, position:"right", grid:{drawOnChartArea:false}, title:{display:true,text:"Revenue ($)"} }
    }
  }
});
</script>

<!-- Export CSV -->
<script>
document.getElementById("export-btn").addEventListener("click",()=>{
  const rows=document.querySelectorAll("#policies-table tr");
  let csv=[];
  rows.forEach(r=>{
    const cols=r.querySelectorAll("td,th");
    const data=Array.from(cols).map(c=>`"${c.innerText.replace(/"/g,'""')}"`);
    csv.push(data.join(","));
  });
  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="policies_export.csv";
  a.click();
});
</script>
{% endblock %}
