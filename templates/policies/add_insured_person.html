{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Add Insured Person | {{ policy.policy_number }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto p-6 bg-white rounded-xl shadow-lg mt-8">

  <h2 class="text-2xl font-bold mb-6">Add Insured Person to Policy: {{ policy.policy_number }}</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="mb-4 px-4 py-2 rounded {{ message.tags|default:'bg-gray-100 text-gray-800' }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <form method="POST" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}

    <div>
      <label class="block font-semibold text-gray-700 mb-1">Full Name</label>
      <input type="text" name="full_name" required class="w-full px-4 py-2 border rounded-lg">
    </div>

    <div>
      <label class="block font-semibold text-gray-700 mb-1">Relationship</label>
      <input type="text" name="relationship" required class="w-full px-4 py-2 border rounded-lg">
    </div>

    <div>
      <label class="block font-semibold text-gray-700 mb-1">Date of Birth</label>
      <input type="date" name="dob" required class="w-full px-4 py-2 border rounded-lg">
    </div>

    <div>
      <label class="block font-semibold text-gray-700 mb-1">Gender</label>
      <select name="gender" class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Gender</option>
        {% for key, label in GENDER_CHOICES %}
          <option value="{{ key }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block font-semibold text-gray-700 mb-1">Photo</label>
      <input type="file" name="photo" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
    </div>

    <!-- Fingerprint Capture (only for adults) -->
    <div id="fingerprint-section" class="hidden mt-2">
      <button type="button" id="capture-fingerprint"
              class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
        Capture Fingerprint
      </button>

      <input type="hidden" name="fingerprint_base64" id="fingerprint_base64">
      <p id="fingerprint-status" class="text-sm text-gray-600 mt-1"></p>
    </div>

    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
      Save Insured Person
    </button>
  </form>

</div>

<script>
  // Show fingerprint section for adults only
  const dobInput = document.querySelector('input[name="dob"]');
  const fingerprintSection = document.getElementById('fingerprint-section');

  dobInput.addEventListener('change', () => {
    const dob = new Date(dobInput.value);
    const today = new Date();
    const age = today.getFullYear() - dob.getFullYear() -
      ((today.getMonth() < dob.getMonth()) ||
       (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate()) ? 1 : 0);

    if (age >= 18) {
      fingerprintSection.classList.remove('hidden');
    } else {
      fingerprintSection.classList.add('hidden');
    }
  });

  // Capture fingerprint via Flask microservice
  document.getElementById('capture-fingerprint').addEventListener('click', () => {
    fetch("{% url 'clients:capture_fingerprint' %}")
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('fingerprint_base64').value = data.fingerprint;
          document.getElementById('fingerprint-status').textContent = "Fingerprint captured ✅";
        } else {
          document.getElementById('fingerprint-status').textContent = "Failed to capture fingerprint ❌";
        }
      });
  });
</script>

{% endblock %}
